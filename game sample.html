<!DOCTYPE html>
<html>
<head>
    <title>Duos & Don'ts Prototype</title>
    <style>
        body { background: #111; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; color: #fff; font-family: sans-serif; }
        canvas { background: #0f0f14; box-shadow: 0 0 20px rgba(0,0,0,0.5); border: 2px solid #444; }
        #controls { position: absolute; bottom: 20px; text-align: center; color: #888; }
    </style>
</head>
<body>
    <canvas id="gameCanvas" width="1000" height="600"></canvas>
    <div id="controls">P1 (Blue): WASD | P2 (Green): Arrows | Restart: R</div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // Game State
        const KEYS = {};
        window.onkeydown = e => KEYS[e.key] = true;
        window.onkeyup = e => KEYS[e.key] = false;

        // Entities
        const p1 = { x: 50, y: 50, w: 30, h: 30, c: '#49f', speed: 4, start: {x:50, y:50} };
        const p2 = { x: 550, y: 50, w: 30, h: 30, c: '#6d6', speed: 4, start: {x:550, y:50} };
        const goal = { x: 450, y: 500, w: 40, h: 40, c: 'gold' };
        
        // Level 5 Layout Simulation
        const walls = [
            {x: 500, y: 0, w: 10, h: 600}, // Divider
            {x: 0, y: 150, w: 300, h: 10}, // P1 Maze
            {x: 200, y: 300, w: 300, h: 10}, // P1 Maze
            {x: 0, y: 450, w: 300, h: 10}  // P1 Maze
        ];
        
        const deactivators = [
            {x: 600, y: 500, w: 40, h: 40, active: false, id: 1}, // Hard to reach
            {x: 800, y: 100, w: 40, h: 40, active: false, id: 2}  // Easy
        ];

        const guards = [
            // The Guard Behind The Treasure (Linked to Hard Deactivator)
            {x: 460, y: 450, w: 20, h: 20, angle: 90, fov: 60, len: 150, id: 1, sweep: 3, sweepOff: 0},
            // Patroller
            {x: 100, y: 200, w: 20, h: 20, angle: 0, fov: 45, len: 120, id: 2, sweep: 0, sweepOff: 0} 
        ];

        let timer = 60;
        let lastTime = Date.now();
        let state = "PLAYING"; // PLAYING, WIN, FAIL

        function reset() {
            p1.x = p1.start.x; p1.y = p1.start.y;
            p2.x = p2.start.x; p2.y = p2.start.y;
            timer = 60;
            state = "PLAYING";
        }

        function rectIntersect(r1, r2) {
            return !(r2.x > r1.x + r1.w || r2.x + r2.w < r1.x || r2.y > r1.y + r1.h || r2.y + r2.h < r1.y);
        }

        function update() {
            if(KEYS['r'] || KEYS['R']) reset();
            if(state !== "PLAYING") return;

            // Timer
            let now = Date.now();
            let dt = (now - lastTime) / 1000;
            lastTime = now;
            timer -= dt;
            if(timer <= 0) reset();

            // P1 Move
            if(KEYS['w']) p1.y -= p1.speed;
            if(KEYS['s']) p1.y += p1.speed;
            if(KEYS['a']) p1.x -= p1.speed;
            if(KEYS['d']) p1.x += p1.speed;

            // P2 Move
            if(KEYS['ArrowUp']) p2.y -= p2.speed;
            if(KEYS['ArrowDown']) p2.y += p2.speed;
            if(KEYS['ArrowLeft']) p2.x -= p2.speed;
            if(KEYS['ArrowRight']) p2.x += p2.speed;

            // Wall Collisions (Respawn P1)
            walls.forEach(w => {
                if(rectIntersect(p1, w)) { p1.x = p1.start.x; p1.y = p1.start.y; }
            });
            // Screen Boundaries
            if(p1.x < 0 || p1.x > 1000 || p1.y < 0 || p1.y > 600) { p1.x = p1.start.x; p1.y = p1.start.y; }

            // Deactivators
            deactivators.forEach(d => {
                d.active = rectIntersect(p2, d);
            });

            // Guards
            guards.forEach(g => {
                // Check Deactivation
                let linked = deactivators.find(d => d.id === g.id);
                if(linked && linked.active) return; // Guard disabled

                // Sweep Logic
                if(g.sweep !== 0) {
                    g.sweepOff += g.sweep;
                    if(Math.abs(g.sweepOff) > 45) g.sweep *= -1;
                }

                // Vision Logic (Simplified for JS Prototype)
                let dx = (p1.x + 15) - (g.x + 10);
                let dy = (p1.y + 15) - (g.y + 10);
                let dist = Math.sqrt(dx*dx + dy*dy);
                
                if(dist < g.len) {
                    // Angle check
                    let angleToP = Math.atan2(dy, dx) * 180 / Math.PI;
                    let facing = g.angle + g.sweepOff;
                    let diff = (angleToP - facing + 180 + 360) % 360 - 180;
                    if(Math.abs(diff) < g.fov / 2) {
                        p1.x = p1.start.x; p1.y = p1.start.y; // Caught
                    }
                }
            });

            if(rectIntersect(p1, goal)) state = "WIN";
        }

        function draw() {
            ctx.fillStyle = "#111";
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Walls
            ctx.fillStyle = "#556";
            walls.forEach(w => ctx.fillRect(w.x, w.y, w.w, w.h));

            // Goal
            ctx.fillStyle = "gold";
            ctx.fillRect(goal.x, goal.y, goal.w, goal.h);

            // Deactivators
            deactivators.forEach(d => {
                ctx.fillStyle = d.active ? "#5f5" : "#848";
                ctx.fillRect(d.x, d.y, d.w, d.h);
            });

            // Guards & Vision
            guards.forEach(g => {
                let linked = deactivators.find(d => d.id === g.id);
                if(linked && linked.active) return; // Don't draw if disabled

                ctx.save();
                ctx.translate(g.x + 10, g.y + 10);
                ctx.rotate((g.angle + g.sweepOff) * Math.PI / 180);
                
                // Cone
                ctx.beginPath();
                ctx.moveTo(0, 0);
                ctx.arc(0, 0, g.len, -g.fov*Math.PI/360, g.fov*Math.PI/360);
                ctx.fillStyle = "rgba(255, 50, 50, 0.3)";
                ctx.fill();

                // Body
                ctx.fillStyle = "red";
                ctx.fillRect(-10, -10, 20, 20);
                ctx.restore();
            });

            // Players
            ctx.fillStyle = p1.c; ctx.fillRect(p1.x, p1.y, p1.w, p1.h);
            ctx.fillStyle = p2.c; ctx.fillRect(p2.x, p2.y, p2.w, p2.h);

            // UI
            ctx.fillStyle = "white";
            ctx.font = "20px Consolas";
            ctx.fillText("Time: " + Math.ceil(timer), 900, 30);
            if(state === "WIN") {
                ctx.fillStyle = "gold";
                ctx.font = "40px Arial";
                ctx.fillText("LEVEL CLEARED", 350, 300);
            }
        }

        function loop() {
            update();
            draw();
            requestAnimationFrame(loop);
        }
        loop();
    </script>
</body>
</html>